from .util import *


def _run_test(action: SelectOne, x_grids: list[Grid],
              y_grids: list[Grid], colorless: bool = False):
    if colorless:
        x_shapes = [list_sparse_objects(
            grid.replace_color(0, -1), True) for grid in x_grids]
        y_shapes = [list_sparse_objects(
            grid.replace_color(0, -1), True) for grid in y_grids]
    else:
        x_shapes = [list_objects(grid.replace_color(0, -1), True) for grid in x_grids]
        y_shapes = [list_objects(grid.replace_color(0, -1), True) for grid in y_grids]
    state = create_test_state(x_shapes, y_shapes)
    program = AttentionExpertProgram(action, GlobalParams())
    result = program.run(state)
    assert result.out_shapes == y_shapes


def test_78():
    params = GlobalParams()
    action = SelectOne(FunctionModel(
        lambda df: np.where(df['group_rank'] > 0.9, 1, 0)),
        Grouping.shape_color, params)

    x_grids = [x78_0, x78_1, x78_2]
    y_grids = [y78_0, y78_1, y78_2]
    _run_test(action, x_grids, y_grids)


def test_206():
    params = GlobalParams()
    action = SelectOne(FunctionModel(
        lambda df: np.where(df['group_rank'] < -0.9, 1, 0)),
        Grouping.shape_color, params)
    x_grids = [x206_0, x206_1, x206_2]
    y_grids = [y206_0, y206_1, y206_2]
    _run_test(action, x_grids, y_grids)


def test_262():
    params = GlobalParams()
    action = SelectOne(FunctionModel(
        lambda df: np.where(df['group_rank'] < -0.9, 1, 0)),
        Grouping.shape, params)
    x_grids = [x262_0, x262_1, x262_2, x262_3]
    y_grids = [y262_0, y262_1, y262_2, y262_3]
    _run_test(action, x_grids, y_grids)


def test_215():
    params = GlobalParams()
    action = SelectOne(FunctionModel(
        lambda df: np.where(df['+color_2_rank'] > 0.9, 1, 0)),
        Grouping.none, params)
    x_grids = [x215_0, x215_1, x215_2]
    y_grids = [y215_0, y215_1, y215_2]
    _run_test(action, x_grids, y_grids, True)


def test_364():
    params = GlobalParams()
    action = SelectOne(FunctionModel(
        lambda df: np.where(df['+color_2_rank'] > 0.9, 1, 0)),
        Grouping.none, params)
    x_grids = [x364_0, x364_1, x364_2]
    y_grids = [y364_0, y364_1, y364_2]
    _run_test(action, x_grids, y_grids, True)


x78_0 = Grid([
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 8, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 8, 0, 8, 0],
    [0, 0, 8, 0, 8, 0, 0, 0, 0, 0, 0, 8, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 8, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 8, 0, 8, 0, 0, 0, 2, 0, 2, 0, 0],
    [0, 0, 0, 0, 8, 0, 0, 0, 0, 2, 0, 2, 0, 0],
    [0, 0, 0, 8, 0, 8, 0, 0, 0, 0, 2, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
])
y78_0 = Grid([
    [8, 0, 8],
    [0, 8, 0],
    [8, 0, 8]
])
x78_1 = Grid([
    [0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0],
    [0, 0, 4, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0],
    [0, 0, 0, 4, 4, 0, 0, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4],
    [0, 0, 0, 0, 0, 0, 2, 0, 2, 0, 0, 4, 0, 0],
    [0, 1, 0, 1, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0],
    [0, 1, 1, 1, 0, 0, 2, 0, 2, 0, 0, 0, 0, 0],
    [0, 0, 1, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 0, 0],
    [0, 0, 4, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0],
    [0, 0, 0, 4, 4, 0, 0, 0, 0, 0, 0, 1, 0, 1],
    [0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0]
])
y78_1 = Grid([
    [4, 0, 0],
    [0, 4, 4],
    [4, 0, 0]
])
x78_2 = Grid([
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 8, 0, 0, 0, 0, 0, 6, 6, 0, 0, 0],
    [0, 0, 8, 8, 8, 0, 0, 0, 0, 6, 6, 0, 0, 0],
    [0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 8, 8, 8, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
])
y78_2 = Grid([
    [0, 8, 0],
    [8, 8, 8],
    [0, 8, 0]
])

x206_0 = Grid([
    [0, 2, 0, 0, 2],
    [2, 2, 0, 2, 2],
    [0, 0, 0, 0, 0],
    [0, 2, 0, 2, 2],
    [2, 2, 0, 2, 0]
])
y206_0 = Grid([
    [2, 2],
    [2, 0]
])
x206_1 = Grid([
    [1, 0, 0, 1, 0],
    [0, 1, 0, 0, 1],
    [0, 0, 0, 0, 0],
    [1, 0, 0, 1, 0],
    [1, 1, 0, 0, 1]
])
y206_1 = Grid([
    [1, 0],
    [1, 1]
])
x206_2 = Grid([
    [8, 8, 0, 0, 8],
    [8, 0, 0, 8, 0],
    [0, 0, 0, 0, 0],
    [8, 8, 0, 8, 8],
    [8, 0, 0, 8, 0]
])
y206_2 = Grid([
    [0, 8],
    [8, 0]
])


x262_0 = Grid([
    [6, 0, 6],
    [0, 6, 6],
    [6, 0, 6],
    [4, 0, 4],
    [0, 4, 4],
    [4, 0, 4],
    [8, 8, 8],
    [8, 0, 8],
    [8, 8, 8]
])
y262_0 = Grid([
    [8, 8, 8],
    [8, 0, 8],
    [8, 8, 8]
])
x262_1 = Grid([
    [2, 0, 0, 3, 0, 0, 7, 0, 7, 1, 0, 0],
    [2, 0, 0, 3, 0, 0, 0, 7, 0, 1, 0, 0],
    [0, 2, 2, 0, 3, 3, 7, 0, 7, 0, 1, 1]
])
y262_1 = Grid([
    [7, 0, 7],
    [0, 7, 0],
    [7, 0, 7]
])
x262_2 = Grid([
    [3, 0, 0, 4, 0, 4, 2, 0, 0, 8, 0, 0, 1, 0, 0],
    [0, 3, 3, 4, 4, 4, 0, 2, 2, 0, 8, 8, 0, 1, 1],
    [0, 3, 0, 4, 0, 4, 0, 2, 0, 0, 8, 0, 0, 1, 0]
])
y262_2 = Grid([
    [4, 0, 4],
    [4, 4, 4],
    [4, 0, 4]
])
x262_3 = Grid([
    [0, 7, 7],
    [7, 7, 0],
    [7, 0, 7],
    [3, 0, 0],
    [0, 3, 3],
    [3, 0, 0],
    [2, 0, 0],
    [0, 2, 2],
    [2, 0, 0],
    [8, 0, 0],
    [0, 8, 8],
    [8, 0, 0]
])
y262_3 = Grid([
    [0, 7, 7],
    [7, 7, 0],
    [7, 0, 7]
])


x215_0 = Grid([
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 1, 1, 1, 0, 0],
    [0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
    [0, 0, 1, 1, 1, 2, 1, 0, 0, 0, 1, 2, 1, 1, 1, 1, 2, 1, 0, 0],
    [0, 0, 1, 1, 2, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
    [0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 2, 1, 1, 1, 1, 0, 0],
    [0, 0, 1, 2, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
    [0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 1, 2, 1, 2, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 1, 1, 2, 1, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 1, 2, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 1, 1, 1, 2, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
])
y215_0 = Grid([
    [1, 1, 1, 1, 1, 1],
    [1, 2, 1, 2, 1, 1],
    [1, 1, 2, 1, 2, 1],
    [1, 2, 1, 1, 1, 1],
    [1, 1, 1, 2, 1, 1]
])
x215_1 = Grid([
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 1, 1, 1, 1, 2, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 1, 2, 1, 1, 1, 1, 1, 1, 2, 0, 0, 0, 1, 1, 1, 1, 1, 2],
    [0, 0, 1, 1, 1, 1, 1, 2, 1, 1, 1, 0, 0, 0, 1, 1, 2, 1, 1, 1],
    [0, 0, 1, 1, 1, 2, 1, 1, 1, 2, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1],
    [0, 0, 2, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 2, 1, 1],
    [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1],
    [0, 0, 1, 1, 1, 1, 1, 2, 1, 1, 1, 0, 0, 0, 1, 2, 1, 1, 1, 1],
    [0, 0, 1, 2, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 2, 1],
    [0, 0, 1, 1, 1, 2, 1, 1, 1, 1, 2, 0, 0, 0, 1, 2, 1, 1, 1, 1],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [1, 1, 1, 2, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [1, 2, 1, 1, 1, 1, 1, 2, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0],
    [1, 1, 1, 1, 2, 1, 1, 1, 1, 0, 0, 1, 1, 1, 2, 1, 1, 0, 0, 0],
    [1, 1, 1, 1, 1, 1, 2, 1, 1, 0, 0, 1, 2, 1, 1, 1, 1, 0, 0, 0],
    [1, 1, 2, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
])
y215_1 = Grid([
    [1, 1, 1, 1, 2, 1, 1, 1, 1],
    [1, 2, 1, 1, 1, 1, 1, 1, 2],
    [1, 1, 1, 1, 1, 2, 1, 1, 1],
    [1, 1, 1, 2, 1, 1, 1, 2, 1],
    [2, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 2, 1, 1, 1],
    [1, 2, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 2, 1, 1, 1, 1, 2]
])
x215_2 = Grid([
    [0, 2, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 1, 1, 1, 2, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 1, 1, 2, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
    [0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 2, 0, 0],
    [0, 1, 2, 1, 1, 2, 1, 0, 0, 1, 1, 2, 1, 1, 1, 1, 1, 1, 0, 0],
    [0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 2, 1, 1, 1, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 2, 1, 1, 1, 1, 1, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
    [0, 0, 0, 2, 1, 2, 1, 0, 0, 1, 1, 1, 2, 1, 1, 1, 2, 1, 0, 0],
    [0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
    [0, 0, 0, 1, 2, 1, 2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
    [0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 0, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 1, 0],
    [0, 0, 1, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 0, 1, 2, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 0]
])
y215_2 = Grid([
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 1],
    [1, 1, 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1],
    [1, 2, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1]
])


x364_0 = Grid([
    [0, 0, 0, 0, 0, 0, 8, 8, 8, 8],
    [0, 8, 8, 8, 8, 0, 8, 2, 2, 8],
    [0, 8, 1, 8, 8, 0, 8, 8, 8, 8],
    [0, 8, 8, 2, 8, 0, 8, 2, 1, 8],
    [0, 8, 8, 8, 8, 0, 8, 8, 8, 8],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 8, 8, 8, 8, 8, 8, 0],
    [0, 0, 0, 8, 8, 8, 2, 8, 8, 0],
    [0, 0, 0, 8, 2, 8, 1, 8, 8, 0],
    [0, 0, 0, 8, 1, 8, 8, 8, 8, 0]
])
y364_0 = Grid([
    [8, 8, 8, 8],
    [8, 2, 2, 8],
    [8, 8, 8, 8],
    [8, 2, 1, 8],
    [8, 8, 8, 8]
])
x364_1 = Grid([
    [1, 1, 1, 8, 0, 0, 0, 0, 0, 0],
    [1, 8, 1, 1, 0, 1, 8, 8, 1, 8],
    [8, 2, 8, 1, 0, 8, 1, 8, 2, 8],
    [1, 1, 1, 8, 0, 8, 8, 8, 8, 1],
    [8, 1, 8, 8, 0, 8, 1, 2, 8, 2],
    [0, 0, 0, 0, 0, 8, 8, 8, 1, 8],
    [0, 0, 0, 0, 0, 1, 1, 8, 1, 8],
    [0, 8, 2, 2, 0, 8, 1, 1, 8, 2],
    [0, 2, 2, 1, 0, 0, 0, 0, 0, 0],
    [0, 2, 1, 8, 0, 0, 0, 0, 0, 0]
])
y364_1 = Grid([
    [8, 2, 2],
    [2, 2, 1],
    [2, 1, 8]
])
x364_2 = Grid([
    [2, 8, 8, 8, 0, 0, 0, 0, 0, 0],
    [8, 8, 1, 8, 0, 0, 0, 0, 0, 0],
    [1, 8, 8, 8, 0, 0, 0, 0, 0, 0],
    [8, 8, 8, 2, 0, 0, 1, 8, 8, 2],
    [8, 2, 8, 1, 0, 0, 8, 8, 1, 8],
    [8, 1, 8, 8, 0, 0, 8, 2, 8, 8],
    [0, 0, 0, 0, 0, 0, 8, 8, 8, 1],
    [0, 0, 0, 0, 0, 0, 1, 8, 8, 8],
    [0, 0, 0, 0, 0, 0, 8, 8, 1, 8],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
])
y364_2 = Grid([
    [2, 8, 8, 8],
    [8, 8, 1, 8],
    [1, 8, 8, 8],
    [8, 8, 8, 2],
    [8, 2, 8, 1],
    [8, 1, 8, 8]
])
